<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <title>Agenda - Marcha</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="agenda.css">
  <script>
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user || (user.role !== 'admin' && user.role !== 'fisio')) {
      window.location.href = 'login.html';
    }
  </script>
</head>

<body>
  <header class="topbar">
    <a href="index.html" class="brand">
      <img src="../assets/logo_marcha.png" alt="Logo" class="logo">
      <span class="title">Cl√≠nica Marcha</span>
    </a>
    <nav class="nav-links">
      <a href="index.html" class="nav-item">üè† <span>In√≠cio</span></a>
      <a href="agenda.html" class="nav-item active">üìÖ <span>Agenda</span></a>
      <a href="pacientes.html" class="nav-item">üë• <span>Clientes & Alunos</span></a>
      <a href="financeiro.html" class="nav-item">üí∞ <span>Financeiro</span></a>
      <a href="profissionais.html" class="nav-item">ü•º <span>Profissionais</span></a>
      <a href="#" onclick="logout()" class="nav-item" style="color: #f44336;">üö™ <span>Sair</span></a>
    </nav>
  </header>

  <main>
    <div class="page-header">
      <h1>Agenda de Atendimentos</h1>
      <div class="header-actions">
        <button class="btn-secondary" onclick="previousWeek()">‚Üê Semana Anterior</button>
        <button class="btn-secondary" onclick="today()">Hoje</button>
        <button class="btn-secondary" onclick="nextWeek()">Pr√≥xima Semana ‚Üí</button>
        <button class="btn-primary" onclick="openNewAppointment()">+ Novo Agendamento</button>
      </div>
    </div>

    <section class="card view-selector">
      <button class="view-btn active" onclick="setView('day')" id="btn-view-day">Dia</button>
      <button class="view-btn" onclick="setView('week')" id="btn-view-week">Semana</button>
      <span id="current-date-display" class="date-display"></span>
    </section>

    <section class="card" id="agenda-container">
      <div id="agenda-view"></div>
    </section>
  </main>

  <!-- Modal Novo/Editar Agendamento -->
  <div id="modal-appointment" class="modal hidden">
    <div class="modal-content modal-large">
      <h3 id="modal-appointment-title">Novo Agendamento</h3>
      <form id="form-appointment">
        <input type="hidden" id="appointment-id" name="id">

        <div class="form-group">
          <label>Paciente *</label>
          <select id="appointment-patient_id" name="patient_id" required></select>
        </div>

        <!-- Title Removed - Auto-generated Backend -->

        <div class="form-row">
          <div class="form-group">
            <label>Data *</label>
            <input type="date" id="appointment-date" name="appointment_date" required>
          </div>
          <div class="form-group">
            <label>Recorr√™ncia</label>
            <select id="appointment-recurrence" name="recurrence">
              <option value="none">Agendamento √önico</option>
              <option value="continuous">Agendamento Cont√≠nuo (12 semanas)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Hor√°rio In√≠cio *</label>
            <input type="time" id="appointment-start_time" name="start_time" required>
          </div>
          <div class="form-group">
            <label>Hor√°rio Fim</label>
            <input type="time" id="appointment-end_time" name="end_time">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Tipo de Servi√ßo</label>
            <select id="appointment-service_type" name="service_type" onchange="updateServicePrice()">
              <option value="Pilates">Pilates</option>
              <option value="Yoga">Yoga</option>
              <option value="Treino Funcional">Treino Funcional</option>
              <option value="Fisioterapia">Fisioterapia</option>
              <option value="Libera√ß√£o Miofascial">Libera√ß√£o Miofascial</option>
              <option value="Condicionamento F√≠sico">Condicionamento F√≠sico</option>
              <option value="Avalia√ß√£o">Avalia√ß√£o</option>
            </select>
          </div>
          <div class="form-group">
            <label>Valor do Servi√ßo (R$)</label>
            <input type="number" step="0.01" id="appointment-price" name="price" placeholder="0,00">
          </div>
          <div class="form-group">
            <label>Profissional</label>
            <input type="text" id="appointment-professional" name="professional">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Status</label>
            <select id="appointment-status" name="status">
              <option value="agendado">Agendado</option>
              <option value="confirmado">Confirmado</option>
              <option value="realizado">Realizado</option>
              <option value="cancelado">Cancelado</option>
              <option value="faltou">Faltou</option>
            </select>
          </div>
          <div class="form-group">
            <label>Pagamento</label>
            <select id="appointment-payment_method" name="payment_method">
              <option value="">Padr√£o (Pendente)</option>
              <option value="dinheiro">Dinheiro</option>
              <option value="pix">PIX</option>
              <option value="cartao_credito">Cart√£o de Cr√©dito</option>
              <option value="cartao_debito">Cart√£o de D√©bito</option>
              <option value="gympass">Gympass</option>
            </select>
          </div>
        </div>

        <!-- Description Removed -->

        <div class="form-group">
          <label>Observa√ß√µes</label>
          <textarea id="appointment-notes" name="notes" rows="2"></textarea>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-success" onclick="sendWhatsAppReminder()"
            style="background:#25D366; color:white; margin-right:auto;">üì± Enviar no Zap</button>
          <button type="submit" class="btn-primary">Salvar</button>
          <button type="button" class="btn-secondary" onclick="closeAppointmentModal()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Confirmar Presen√ßa -->
  <div id="modal-confirm-presence" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Confirmar Presen√ßa</h3>
        <button class="btn-close-modal" onclick="closeConfirmModal()">&times;</button>
      </div>
      <p>Confirme os dados financeiros desta aula:</p>
      <form id="form-confirm-presence">
        <input type="hidden" id="confirm-appt-id">
        <div class="form-group">
          <label>Valor Pago (R$)</label>
          <input type="number" id="confirm-amount" step="0.01" min="0">
        </div>
        <div class="form-group">
          <label>Forma de Pagamento</label>
          <select id="confirm-payment-method">
            <option value="dinheiro">Dinheiro</option>
            <option value="pix">PIX</option>
            <option value="cartao_credito">Cart√£o de Cr√©dito</option>
            <option value="cartao_debito">Cart√£o de D√©bito</option>
            <option value="gympass">Gympass</option>
            <option value="transferencia">Transfer√™ncia</option>
          </select>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn-primary">Confirmar e Pontuar üèÜ</button>
          <button type="button" class="btn-warning" onclick="confirmAbsence()"
            style="background-color: #ff9800; color: white;">Aluno Faltou</button>
          <button type="button" class="btn-secondary" onclick="closeConfirmModal()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <script src="utils.js"></script>
  <script src="agenda.js?v=10"></script>
</body>

</html>