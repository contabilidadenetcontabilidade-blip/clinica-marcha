<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <title>Pacientes - Marcha</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="pacientes.css">
  <script>
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user || (user.role !== 'admin' && user.role !== 'fisio')) {
      window.location.href = 'login.html';
    }
  </script>
</head>

<body>
  <header class="topbar">
    <a href="index.html" class="brand">
      <img src="../assets/logo_marcha.png" alt="Logo" class="logo">
      <span class="title">ClÃ­nica Marcha</span>
    </a>
    <nav class="nav-links">
      <a href="index.html" class="nav-item">ğŸ  <span>InÃ­cio</span></a>
      <a href="agenda.html" class="nav-item">ğŸ“… <span>Agenda</span></a>
      <a href="pacientes.html" class="nav-item active">ğŸ‘¥ <span>Clientes & Alunos</span></a>
      <a href="financeiro.html" class="nav-item">ğŸ’° <span>Financeiro</span></a>
      <a href="profissionais.html" class="nav-item">ğŸ¥¼ <span>Profissionais</span></a>
      <a href="#" onclick="logout()" class="nav-item" style="color: #f44336;">ğŸšª <span>Sair</span></a>
    </nav>
  </header>

  <main>
    <div class="page-header">
      <h1>Clientes & Alunos</h1>
      <button class="btn-primary" onclick="openNewPatient()">+ Novo Cadastro</button>
      <button class="btn-secondary" onclick="generateInviteLink()" style="margin-left:10px;">ğŸ”— Gerar Link
        (24h)</button>
    </div>

    <section class="card search-section">
      <input type="text" id="search-input" placeholder="Buscar por nome, CPF ou telefone..." onkeyup="searchPatients()">
      <label class="filter-active">
        <input type="checkbox" id="filter-active" checked onchange="loadPatients()">
        Mostrar apenas ativos
      </label>
    </section>

    <section class="card">
      <div id="patients-list-container">
        <ul id="patients-list">
          <li>Carregando...</li>
        </ul>
      </div>
    </section>
  </main>

  <!-- Modal Novo/Editar Paciente -->
  <div id="modal-patient" class="modal hidden">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3 id="modal-patient-title" class="modal-title">Novo Cadastro - ClÃ­nica Marcha</h3>
        <button class="btn-close-modal" onclick="closePatientModal()">&times;</button>
      </div>
      <form id="form-patient">
        <input type="hidden" id="patient-id" name="id">

        <div class="form-row">
          <div class="form-group" style="text-align: center;">
            <div class="photo-preview-container" style="margin-bottom: 10px;">
              <img id="patient-photo-preview" src="../assets/default-user.png" alt="Foto"
                style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd;">
            </div>
            <label class="btn-secondary btn-sm" style="cursor: pointer; display: inline-block;">
              ğŸ“· Escolher Foto
              <input type="file" id="patient-photo" name="photo" accept="image/*" style="display: none;"
                onchange="previewPhoto(this)">
            </label>
          </div>
        </div>

        <div class="form-row">
          <!-- Type Field Hidden/Disabled as requested -->
          <input type="hidden" name="type" value="Cliente">

          <div class="form-group" style="flex: 2;">
            <label>Nome Completo *</label>
            <input type="text" id="patient-name" name="name" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>CPF</label>
            <input type="text" id="patient-cpf" name="cpf" placeholder="000.000.000-00">
          </div>
          <div class="form-group">
            <label>Login (Username)</label>
            <input type="text" id="patient-username" name="username" placeholder="teste.aluno">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Casa (Marcha Cup) ğŸ†</label>
            <select id="patient-house" name="house_id">
              <option value="">-- Sem Casa --</option>
              <!-- Populated by JS -->
            </select>
          </div>
          <div class="form-group">
            <label>Data de Nascimento</label>
            <input type="date" id="patient-birth_date" name="birth_date">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Telefone *</label>
            <input type="tel" id="patient-phone" name="phone" placeholder="(00) 00000-0000" required>
          </div>
          <div class="form-group">
            <label>E-mail</label>
            <input type="email" id="patient-email" name="email">
          </div>
          <div class="form-group">
            <label>Senha de Acesso</label>
            <input type="text" id="patient-password" name="password" placeholder="PadrÃ£o: aluno">
          </div>
        </div>

        <div class="form-group">
          <label>EndereÃ§o</label>
          <input type="text" id="patient-address" name="address">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Cidade</label>
            <input type="text" id="patient-city" name="city">
          </div>
          <div class="form-group">
            <label>Estado</label>
            <input type="text" id="patient-state" name="state" maxlength="2" placeholder="SP">
          </div>
          <div class="form-group">
            <label>CEP</label>
            <input type="text" id="patient-zip_code" name="zip_code" placeholder="00000-000">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Contato de EmergÃªncia</label>
            <input type="text" id="patient-emergency_contact" name="emergency_contact">
          </div>
          <div class="form-group">
            <label>Telefone de EmergÃªncia</label>
            <input type="tel" id="patient-emergency_phone" name="emergency_phone">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>ConvÃªnio</label>
            <input type="text" id="patient-health_insurance" name="health_insurance">
          </div>
          <div class="form-group">
            <label>NÃºmero do ConvÃªnio</label>
            <input type="text" id="patient-health_insurance_number" name="health_insurance_number">
          </div>
        </div>

        <div class="form-group">
          <label>ObservaÃ§Ãµes</label>
          <textarea id="patient-notes" name="notes" rows="3"></textarea>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-primary">Salvar</button>
          <button type="button" class="btn-secondary" onclick="closePatientModal()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <script src="utils.js"></script>
  <script src="pacientes.js"></script>
</body>

</html>